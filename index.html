<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>é‰„å¡” æ®µå‰²ã‚Šè¨ˆç®—</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap');

:root {
â€“bg: #f5f4f0;
â€“white: #ffffff;
â€“accent: #1a6b4a;
â€“accent-light: #e8f5ee;
â€“text: #1a1a1a;
â€“muted: #888;
â€“border: #ddd;
}

- { box-sizing: border-box; margin: 0; padding: 0; }

body {
background: var(â€“bg);
color: var(â€“text);
font-family: â€˜Noto Sans JPâ€™, sans-serif;
font-weight: 300;
min-height: 100vh;
padding: 20px 16px 40px;
}

h1 { font-size: 1.1rem; font-weight: 700; color: var(â€“accent); margin-bottom: 4px; }
.subtitle { font-size: 0.78rem; color: var(â€“muted); margin-bottom: 20px; }

.card {
background: var(â€“white);
border-radius: 16px;
padding: 20px;
margin-bottom: 16px;
box-shadow: 0 2px 8px rgba(0,0,0,0.07);
}

.card h2 {
font-size: 0.72rem; font-weight: 700; color: var(â€“muted);
letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 14px;
}

.section-label {
font-size: 0.78rem; color: var(â€“muted);
margin: 16px 0 10px; padding-bottom: 4px;
border-bottom: 1px solid var(â€“border);
}

.input-row {
display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
}

.input-row label { font-size: 0.85rem; width: 140px; flex-shrink: 0; color: var(â€“text); }

.input-row input[type=â€œnumberâ€] {
flex: 1; font-size: 1.2rem; font-weight: 700; color: var(â€“accent);
border: 2px solid var(â€“border); border-radius: 10px; padding: 10px 14px;
outline: none; background: var(â€“white);
-webkit-appearance: none; appearance: none; transition: border-color 0.2s;
}
.input-row input[type=â€œnumberâ€]:focus { border-color: var(â€“accent); background: var(â€“accent-light); }

.unit { font-size: 0.85rem; color: var(â€“muted); width: 28px; }

.btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px; }

.tog-btn {
flex: 1; min-width: 100px; padding: 10px 8px; border-radius: 10px;
border: 2px solid var(â€“border); background: var(â€“white);
font-family: inherit; font-size: 0.82rem; color: var(â€“muted);
cursor: pointer; text-align: center; transition: all 0.2s; font-weight: 400;
}
.tog-btn.active {
border-color: var(â€“accent); background: var(â€“accent-light);
color: var(â€“accent); font-weight: 700;
}

.hint { font-size: 0.72rem; color: var(â€“muted); line-height: 1.6; margin-top: 6px; margin-bottom: 10px; }

.result-header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 14px; }
.result-header h2 { margin-bottom: 0; }
.total-check { font-size: 0.75rem; color: var(â€“muted); margin-left: auto; }
.total-check span { color: var(â€“accent); font-weight: 700; }

.seg-list { display: flex; flex-direction: column; gap: 8px; }

.seg-item {
display: flex; align-items: center; gap: 10px;
background: var(â€“bg); border-radius: 10px; padding: 10px 14px;
}
.seg-label { font-size: 0.78rem; color: var(â€“muted); width: 64px; flex-shrink: 0; }
.seg-value { font-size: 1.15rem; font-weight: 700; color: var(â€“accent); width: 72px; text-align: right; flex-shrink: 0; }
.seg-unit  { font-size: 0.78rem; color: var(â€“muted); margin-left: 2px; flex-shrink: 0; }

.seg-bar-wrap { flex: 1; background: var(â€“border); border-radius: 4px; height: 8px; overflow: hidden; }
.seg-bar { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(â€“accent), #4aaa80); transition: width 0.3s; }

.preview-wrap { display: flex; justify-content: center; padding: 8px 0 4px; }
canvas { border-radius: 8px; background: #f0f0ea; }

.save-btn {
display: block; width: 100%; margin-top: 14px; padding: 12px;
background: var(â€“accent); color: #fff; border: none; border-radius: 10px;
font-family: inherit; font-size: 0.95rem; font-weight: 700;
cursor: pointer; letter-spacing: 0.05em; transition: opacity 0.2s;
}
.save-btn:active { opacity: 0.7; }

.error {
color: #c0392b; font-size: 0.82rem; padding: 10px 14px;
background: #fdecea; border-radius: 8px; display: none; margin-bottom: 10px;
}
</style>

</head>
<body>

<h1>âš¡ æ®µå‰²ã‚Šè¨ˆç®—ãƒ„ãƒ¼ãƒ«</h1>
<div class="subtitle">ç·šã®é•·ã•ã‚’æŒ‡å®šã—ãŸæ®µæ•°ã«åˆ†å‰²ã—ã¾ã™</div>

<!-- å…¥åŠ›ï¼ˆãã³ã‚Œå«ã‚€ï¼‰ -->

<div class="card">
  <h2>å…¥åŠ›</h2>

  <div class="section-label">â–¸ åŸºæœ¬è¨­å®š</div>
  <div class="input-row">
    <label>ç·šã®å…¨ä½“ã®é•·ã•</label>
    <input type="number" id="totalLen" value="200" min="1" step="0.1">
    <span class="unit">mm</span>
  </div>
  <div class="input-row">
    <label>åˆ†å‰²ã™ã‚‹æ®µæ•°</label>
    <input type="number" id="numSeg" value="8" min="2" max="30" step="1">
    <span class="unit">æ®µ</span>
  </div>
  <div class="input-row">
    <label>ä¸‹ç«¯ã®å¹…</label>
    <input type="number" id="widthBottom" value="100" min="1" step="0.1">
    <span class="unit">mm</span>
  </div>
  <div class="input-row">
    <label>ä¸Šç«¯ã®å¹…</label>
    <input type="number" id="widthTop" value="20" min="0" step="0.1">
    <span class="unit">mm</span>
  </div>

  <div class="section-label">â–¸ ãã³ã‚Œè¨­å®š</div>
  <div class="btn-row">
    <button class="tog-btn active" id="btnWaistNone">ãã³ã‚Œãªã—</button>
    <button class="tog-btn"        id="btnWaistOn">ãã³ã‚Œã‚ã‚Š</button>
  </div>
  <div id="waistInputs" style="display:none; margin-top:10px">
    <div class="input-row">
      <label>ãã³ã‚Œä½ç½®ï¼ˆä¸‹ã‹ã‚‰ä½•æ®µç›®ï¼‰</label>
      <input type="number" id="waistSeg" value="3" min="1" step="1">
      <span class="unit">æ®µ</span>
    </div>
    <div class="input-row">
      <label>ãã³ã‚Œã®å¹…</label>
      <input type="number" id="waistWidth" value="15" min="1" step="0.1">
      <span class="unit">mm</span>
    </div>
    <div class="hint">æŒ‡å®šã—ãŸæ®µã®ä¸Šç«¯ã§ã„ã¡ã©ç´°ããªã‚Šã€ãã“ã‹ã‚‰ä¸Šç«¯ã®å¹…ã¸åºƒãŒã‚Šã¾ã™ã€‚</div>
  </div>
</div>

<!-- å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ -->

<div class="card">
  <h2>é–“éš”ã®å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³</h2>
  <div class="btn-row">
    <button class="tog-btn"        id="btnRatio">ç­‰æ¯”ï¼ˆè‡ªç„¶ãªç¸®ã¿ï¼‰</button>
    <button class="tog-btn active" id="btnLinear">ç­‰å·®ï¼ˆå‡ç­‰ã«ç¸®å°ï¼‰</button>
  </div>
  <div class="hint" id="modeHint">æ®µã”ã¨ã«ä¸€å®šã®é•·ã•ãšã¤å‡ç­‰ã«å°ã•ããªã‚Šã¾ã™ã€‚ãªã ã‚‰ã‹ã§è¦å‰‡çš„ãªè¦‹ãŸç›®ã«ãªã‚Šã¾ã™ã€‚</div>

  <div id="ratioInput" style="display:none; margin-top:4px">
    <div class="input-row">
      <label>ç¸®å°æ¯”ç‡</label>
      <input type="number" id="ratio" value="0.85" min="0.5" max="0.99" step="0.01">
      <span class="unit"></span>
    </div>
    <div class="hint">ä¸Šã®æ®µ = ä¸‹ã®æ®µ Ã— ã“ã®æ¯”ç‡ã€€ä¾‹ï¼š0.85 ãªã‚‰ä¸Šã®æ®µã¯ä¸‹ã®æ®µã® 85%</div>
  </div>

  <div id="linearInput" style="margin-top:4px">
    <div class="input-row">
      <label>æœ€ä¸Šæ®µ / æœ€ä¸‹æ®µ</label>
      <input type="number" id="linearRatio" value="0.4" min="0.1" max="0.9" step="0.05">
      <span class="unit"></span>
    </div>
    <div class="hint">ä¾‹ï¼š0.4 ãªã‚‰æœ€ä¸Šæ®µã¯æœ€ä¸‹æ®µã® 40% ã®é•·ã•</div>
  </div>
</div>

<!-- çµæœ -->

<div class="card">
  <div class="result-header">
    <h2>è¨ˆç®—çµæœï¼ˆä¸‹ã‹ã‚‰é †ï¼‰</h2>
    <div class="total-check">åˆè¨ˆ <span id="totalDisplay">â€”</span> mm</div>
  </div>
  <div class="error" id="errorMsg">å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
  <div class="seg-list" id="segList"></div>
</div>

<!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->

<div class="card">
  <h2>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
  <div class="preview-wrap">
    <canvas id="cv" width="400" height="1200" style="width:100px;height:300px;"></canvas>
  </div>
  <button class="save-btn" id="saveBtn">ğŸ“¥ ç”»åƒã¨ã—ã¦ä¿å­˜ï¼ˆPNGï¼‰</button>
</div>

<script>
  // â”€â”€ çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let mode     = 'linear';
  let hasWaist = false;

  // â”€â”€ ãã³ã‚Œãƒœã‚¿ãƒ³ï¼ˆä»–ã®ãƒœã‚¿ãƒ³ã«å¹²æ¸‰ã—ãªã„ã‚ˆã†å€‹åˆ¥ã«å®šç¾©ï¼‰â”€â”€
  document.getElementById('btnWaistNone').addEventListener('click', () => {
    hasWaist = false;
    document.getElementById('btnWaistNone').classList.add('active');
    document.getElementById('btnWaistOn').classList.remove('active');
    document.getElementById('waistInputs').style.display = 'none';
    calc();
  });
  document.getElementById('btnWaistOn').addEventListener('click', () => {
    hasWaist = true;
    document.getElementById('btnWaistOn').classList.add('active');
    document.getElementById('btnWaistNone').classList.remove('active');
    document.getElementById('waistInputs').style.display = '';
    calc();
  });

  // â”€â”€ å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒœã‚¿ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btnRatio').addEventListener('click', () => {
    mode = 'ratio';
    document.getElementById('btnRatio').classList.add('active');
    document.getElementById('btnLinear').classList.remove('active');
    document.getElementById('ratioInput').style.display = '';
    document.getElementById('linearInput').style.display = 'none';
    document.getElementById('modeHint').textContent = 'ä¸Šã®æ®µãŒä¸‹ã®æ®µã®ä¸€å®šæ¯”ç‡ã§å°ã•ããªã‚Šã¾ã™ã€‚è‡ªç„¶ãªç¸®ã¿æ–¹ã«ãªã‚Šã¾ã™ã€‚';
    calc();
  });
  document.getElementById('btnLinear').addEventListener('click', () => {
    mode = 'linear';
    document.getElementById('btnLinear').classList.add('active');
    document.getElementById('btnRatio').classList.remove('active');
    document.getElementById('ratioInput').style.display = 'none';
    document.getElementById('linearInput').style.display = '';
    document.getElementById('modeHint').textContent = 'æ®µã”ã¨ã«ä¸€å®šã®é•·ã•ãšã¤å‡ç­‰ã«å°ã•ããªã‚Šã¾ã™ã€‚ãªã ã‚‰ã‹ã§è¦å‰‡çš„ãªè¦‹ãŸç›®ã«ãªã‚Šã¾ã™ã€‚';
    calc();
  });

  // â”€â”€ æ•°å€¤å…¥åŠ› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ['totalLen','numSeg','widthBottom','widthTop','waistSeg','waistWidth','ratio','linearRatio'].forEach(id => {
    document.getElementById(id).addEventListener('input', calc);
  });

  // â”€â”€ è¨ˆç®—ãƒ¡ã‚¤ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function calc() {
    const total = parseFloat(document.getElementById('totalLen').value);
    const n     = Math.min(30, Math.max(2, parseInt(document.getElementById('numSeg').value) || 2));
    const errEl = document.getElementById('errorMsg');

    if (!total || total <= 0) { errEl.style.display = 'block'; return; }
    errEl.style.display = 'none';

    // æ®µã®é«˜ã•ãƒªã‚¹ãƒˆï¼ˆä¸‹ã‹ã‚‰é †ã€index 0 = æœ€ä¸‹æ®µï¼‰
    let heights = [];
    if (mode === 'ratio') {
      const r = parseFloat(document.getElementById('ratio').value) || 0.85;
      if (r >= 1 || r <= 0) return;
      const a = total * (1 - r) / (1 - Math.pow(r, n));
      for (let i = 0; i < n; i++) heights.push(a * Math.pow(r, i));
    } else {
      const lr = parseFloat(document.getElementById('linearRatio').value) || 0.4;
      const a  = total / (n * (1 - (1 - lr) / 2));
      const d  = a * (1 - lr) / (n - 1);
      for (let i = 0; i < n; i++) heights.push(a - d * i);
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«
    const list = document.getElementById('segList');
    list.innerHTML = '';
    const maxH = heights[0];
    let sum = 0;
    heights.forEach((h, i) => {
      sum += h;
      const div = document.createElement('div');
      div.className = 'seg-item';
      div.innerHTML = `
        <div class="seg-label">ç¬¬${i+1}æ®µç›®</div>
        <div class="seg-value">${h.toFixed(2)}</div>
        <div class="seg-unit">mm</div>
        <div class="seg-bar-wrap"><div class="seg-bar" style="width:${(h/maxH*100).toFixed(0)}%"></div></div>
      `;
      list.appendChild(div);
    });
    document.getElementById('totalDisplay').textContent = sum.toFixed(2);

    drawPreview(heights, n);
  }

  // â”€â”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function drawPreview(heights, n) {
    const cv  = document.getElementById('cv');
    const ctx = cv.getContext('2d');
    const pw  = cv.width, ph = cv.height;
    ctx.clearRect(0, 0, pw, ph);

    const pad    = 20;
    const total  = heights.reduce((a, b) => a + b, 0);
    const scaleY = (ph - pad * 2) / total;

    const wBottom  = parseFloat(document.getElementById('widthBottom').value) || 100;
    const wTop     = parseFloat(document.getElementById('widthTop').value)    || 20;
    const waistWmm = hasWaist ? (parseFloat(document.getElementById('waistWidth').value) || 15) : 0;
    const waistAt  = hasWaist
      ? Math.min(n - 1, Math.max(1, parseInt(document.getElementById('waistSeg').value) || 3))
      : 0;

    // å„å¢ƒç•Œã®Yåº§æ¨™ã‚’äº‹å‰ã«è¨ˆç®—ï¼ˆcanvasåº§æ¨™ï¼šä¸‹ãŒå¤§ãã„ï¼‰
    // boundaryY[0] = æœ€ä¸‹ç«¯, boundaryY[n] = æœ€ä¸Šç«¯
    const boundaryY = [ph - pad];
    for (let i = 0; i < n; i++) {
      boundaryY.push(boundaryY[i] - heights[i] * scaleY);
    }

    const totalH = ph - pad * 2; // canvasä¸Šã®å…¨é«˜(px)

    // Yåº§æ¨™(canvas)ã‹ã‚‰å¹…(mm)ã‚’æ±‚ã‚ã‚‹
    // Yåº§æ¨™ãŒå°ã•ã„ã»ã©ä¸Šï¼ˆt=1ï¼‰ã€å¤§ãã„ã»ã©ä¸‹ï¼ˆt=0ï¼‰
    function widthAtY(y) {
      const t = (ph - pad - y) / totalH; // 0=æœ€ä¸‹ç«¯, 1=æœ€ä¸Šç«¯

      if (!hasWaist) {
        return wBottom + (wTop - wBottom) * t;
      }

      // ãã³ã‚Œå¢ƒç•Œã®Yåº§æ¨™ã‹ã‚‰tã‚’è¨ˆç®—
      const tWaist = (ph - pad - boundaryY[waistAt]) / totalH;

      if (t <= tWaist) {
        // ä¸‹åŒºé–“ï¼š0â†’tWaist ã§ wBottomâ†’waistWmm
        return wBottom + (waistWmm - wBottom) * (t / tWaist);
      } else {
        // ä¸ŠåŒºé–“ï¼štWaistâ†’1 ã§ waistWmmâ†’wTop
        return waistWmm + (wTop - waistWmm) * ((t - tWaist) / (1 - tWaist));
      }
    }

    // ã‚­ãƒ£ãƒ³ãƒã‚¹å¹…ã‚¹ã‚±ãƒ¼ãƒ«
    const wMax   = Math.max(wBottom, wTop, hasWaist ? waistWmm : 0);
    const wScale = (pw - pad * 2) / wMax;

    const cx = pw / 2;
    let y = ph - pad;

    heights.forEach((h, i) => {
      const segH = h * scaleY;
      const bw   = widthAtY(boundaryY[i])     * wScale;
      const tw   = widthAtY(boundaryY[i + 1]) * wScale;

      // å°å½¢
      ctx.beginPath();
      ctx.moveTo(cx - bw/2, y);
      ctx.lineTo(cx + bw/2, y);
      ctx.lineTo(cx + tw/2, y - segH);
      ctx.lineTo(cx - tw/2, y - segH);
      ctx.closePath();
      ctx.strokeStyle = '#1a6b4a';
      ctx.lineWidth = 6;
      ctx.stroke();

      // äº¤å·®ç·š
      ctx.beginPath();
      ctx.moveTo(cx - bw/2, y);
      ctx.lineTo(cx + tw/2, y - segH);
      ctx.moveTo(cx + bw/2, y);
      ctx.lineTo(cx - tw/2, y - segH);
      ctx.strokeStyle = '#aacfbe';
      ctx.lineWidth = 3;
      ctx.stroke();

      y -= segH;
    });
  }

  // â”€â”€ ä¿å­˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('saveBtn').addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = 'tower-preview.png';
    link.href = document.getElementById('cv').toDataURL('image/png');
    link.click();
  });

  calc();
</script>

</body>
</html>
