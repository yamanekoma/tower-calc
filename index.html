<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>é‰„å¡” æ®µå‰²ã‚Šè¨ˆç®—</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap');

:root {
â€“bg: #f5f4f0;
â€“white: #ffffff;
â€“accent: #1a6b4a;
â€“accent-light: #e8f5ee;
â€“text: #1a1a1a;
â€“muted: #888;
â€“border: #ddd;
}

- { box-sizing: border-box; margin: 0; padding: 0; }

body {
background: var(â€“bg);
color: var(â€“text);
font-family: â€˜Noto Sans JPâ€™, sans-serif;
font-weight: 300;
height: 100dvh;
display: flex;
flex-direction: column;
overflow: hidden;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.header {
padding: 12px 16px 8px;
flex-shrink: 0;
}
h1 { font-size: 1rem; font-weight: 700; color: var(â€“accent); }
.subtitle { font-size: 0.72rem; color: var(â€“muted); }

/* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.main {
display: flex;
flex: 1;
overflow: hidden;
gap: 0;
}

/* å·¦ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªå…¥åŠ›ã‚¨ãƒªã‚¢ */
.pane-left {
flex: 1;
overflow-y: auto;
padding: 8px 12px 24px;
-webkit-overflow-scrolling: touch;
}

/* å³ï¼šå›ºå®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
.pane-right {
width: 120px;
flex-shrink: 0;
background: var(â€“white);
border-left: 1px solid var(â€“border);
display: flex;
flex-direction: column;
align-items: center;
padding: 10px 6px;
gap: 10px;
}

.pane-right h2 {
font-size: 0.65rem;
font-weight: 700;
color: var(â€“muted);
letter-spacing: 0.08em;
text-transform: uppercase;
}

canvas {
border-radius: 6px;
background: #f0f0ea;
max-height: calc(100dvh - 120px);
width: 90px;
}

.save-btn {
width: 100%;
padding: 8px 4px;
background: var(â€“accent);
color: #fff;
border: none;
border-radius: 8px;
font-family: inherit;
font-size: 0.7rem;
font-weight: 700;
cursor: pointer;
text-align: center;
transition: opacity 0.2s;
line-height: 1.4;
}
.save-btn:active { opacity: 0.7; }

/* ã‚«ãƒ¼ãƒ‰ */
.card {
background: var(â€“white);
border-radius: 12px;
padding: 14px;
margin-bottom: 10px;
box-shadow: 0 1px 4px rgba(0,0,0,0.07);
}

.card h2 {
font-size: 0.68rem;
font-weight: 700;
color: var(â€“muted);
letter-spacing: 0.08em;
text-transform: uppercase;
margin-bottom: 12px;
}

.section-label {
font-size: 0.72rem;
color: var(â€“muted);
margin: 12px 0 8px;
padding-bottom: 3px;
border-bottom: 1px solid var(â€“border);
}

/* å…¥åŠ›è¡Œï¼ˆãƒ©ãƒ™ãƒ«ï¼‹æ•°å€¤ï¼‹ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼‰ */
.field {
margin-bottom: 12px;
}

.field-top {
display: flex;
align-items: center;
gap: 6px;
margin-bottom: 4px;
}

.field-top label {
font-size: 0.8rem;
flex: 1;
color: var(â€“text);
}

.field-top input[type=â€œnumberâ€] {
width: 72px;
flex-shrink: 0;
font-size: 1rem;
font-weight: 700;
color: var(â€“accent);
border: 2px solid var(â€“border);
border-radius: 8px;
padding: 5px 8px;
outline: none;
background: var(â€“white);
-webkit-appearance: none;
appearance: none;
transition: border-color 0.2s;
text-align: right;
}
.field-top input[type=â€œnumberâ€]:focus {
border-color: var(â€“accent);
background: var(â€“accent-light);
}

.unit {
font-size: 0.78rem;
color: var(â€“muted);
width: 22px;
flex-shrink: 0;
}

/* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
input[type=â€œrangeâ€] {
width: 100%;
height: 4px;
-webkit-appearance: none;
appearance: none;
background: var(â€“border);
border-radius: 2px;
outline: none;
cursor: pointer;
}
input[type=â€œrangeâ€]::-webkit-slider-thumb {
-webkit-appearance: none;
width: 22px;
height: 22px;
border-radius: 50%;
background: var(â€“accent);
border: 3px solid var(â€“white);
box-shadow: 0 1px 4px rgba(0,0,0,0.2);
cursor: pointer;
}

/* ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
.btn-row { display: flex; gap: 6px; margin-bottom: 8px; }

.tog-btn {
flex: 1;
padding: 8px 6px;
border-radius: 8px;
border: 2px solid var(â€“border);
background: var(â€“white);
font-family: inherit;
font-size: 0.75rem;
color: var(â€“muted);
cursor: pointer;
text-align: center;
transition: all 0.2s;
font-weight: 400;
}
.tog-btn.active {
border-color: var(â€“accent);
background: var(â€“accent-light);
color: var(â€“accent);
font-weight: 700;
}

.hint {
font-size: 0.68rem;
color: var(â€“muted);
line-height: 1.5;
margin-top: 4px;
margin-bottom: 6px;
}

/* çµæœãƒªã‚¹ãƒˆ */
.seg-list { display: flex; flex-direction: column; gap: 6px; }

.seg-item {
display: flex;
align-items: center;
gap: 8px;
background: var(â€“bg);
border-radius: 8px;
padding: 7px 10px;
}
.seg-label { font-size: 0.72rem; color: var(â€“muted); width: 56px; flex-shrink: 0; }
.seg-value { font-size: 1rem; font-weight: 700; color: var(â€“accent); width: 60px; text-align: right; flex-shrink: 0; }
.seg-unit  { font-size: 0.72rem; color: var(â€“muted); margin-left: 2px; flex-shrink: 0; }
.seg-bar-wrap { flex: 1; background: var(â€“border); border-radius: 3px; height: 6px; overflow: hidden; }
.seg-bar { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(â€“accent), #4aaa80); }

.total-row {
display: flex;
justify-content: flex-end;
font-size: 0.75rem;
color: var(â€“muted);
margin-top: 6px;
}
.total-row span { color: var(â€“accent); font-weight: 700; margin-left: 4px; }

.error {
color: #c0392b; font-size: 0.78rem;
padding: 8px 12px; background: #fdecea;
border-radius: 8px; display: none; margin-bottom: 8px;
}
</style>

</head>
<body>

<div class="header">
  <h1>âš¡ æ®µå‰²ã‚Šè¨ˆç®—ãƒ„ãƒ¼ãƒ«</h1>
  <div class="subtitle">ç·šã®é•·ã•ã‚’æŒ‡å®šã—ãŸæ®µæ•°ã«åˆ†å‰²ã—ã¾ã™</div>
</div>

<div class="main">

  <!-- å·¦ï¼šå…¥åŠ›ã‚¨ãƒªã‚¢ -->

  <div class="pane-left">

```
<!-- å…¥åŠ›ã‚«ãƒ¼ãƒ‰ -->
<div class="card">
  <h2>å…¥åŠ›</h2>

  <div class="section-label">â–¸ åŸºæœ¬è¨­å®š</div>

  <div class="field">
    <div class="field-top">
      <label>å…¨ä½“ã®é•·ã•</label>
      <input type="number" id="totalLen" value="200" min="10" max="2000" step="1">
      <span class="unit">mm</span>
    </div>
    <input type="range" id="totalLenR" min="10" max="2000" step="1" value="200">
  </div>

  <div class="field">
    <div class="field-top">
      <label>åˆ†å‰²ã™ã‚‹æ®µæ•°</label>
      <input type="number" id="numSeg" value="8" min="2" max="30" step="1">
      <span class="unit">æ®µ</span>
    </div>
    <input type="range" id="numSegR" min="2" max="30" step="1" value="8">
  </div>

  <div class="field">
    <div class="field-top">
      <label>ä¸‹ç«¯ã®å¹…</label>
      <input type="number" id="widthBottom" value="100" min="1" max="500" step="1">
      <span class="unit">mm</span>
    </div>
    <input type="range" id="widthBottomR" min="1" max="500" step="1" value="100">
  </div>

  <div class="field">
    <div class="field-top">
      <label>ä¸Šç«¯ã®å¹…</label>
      <input type="number" id="widthTop" value="20" min="0" max="500" step="1">
      <span class="unit">mm</span>
    </div>
    <input type="range" id="widthTopR" min="0" max="500" step="1" value="20">
  </div>

  <div class="section-label">â–¸ ãã³ã‚Œè¨­å®š</div>
  <div class="btn-row">
    <button class="tog-btn active" id="btnWaistNone">ãã³ã‚Œãªã—</button>
    <button class="tog-btn"        id="btnWaistOn">ãã³ã‚Œã‚ã‚Š</button>
  </div>

  <div id="waistInputs" style="display:none">
    <div class="field">
      <div class="field-top">
        <label>ãã³ã‚Œä½ç½®ï¼ˆä¸‹ã‹ã‚‰ä½•æ®µç›®ï¼‰</label>
        <input type="number" id="waistSeg" value="3" min="1" max="29" step="1">
        <span class="unit">æ®µ</span>
      </div>
      <input type="range" id="waistSegR" min="1" max="29" step="1" value="3">
    </div>
    <div class="field">
      <div class="field-top">
        <label>ãã³ã‚Œã®å¹…</label>
        <input type="number" id="waistWidth" value="15" min="1" max="500" step="1">
        <span class="unit">mm</span>
      </div>
      <input type="range" id="waistWidthR" min="1" max="500" step="1" value="15">
    </div>
  </div>
</div>

<!-- å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ -->
<div class="card">
  <h2>é–“éš”ã®å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³</h2>
  <div class="btn-row">
    <button class="tog-btn"        id="btnRatio">ç­‰æ¯”</button>
    <button class="tog-btn active" id="btnLinear">ç­‰å·®</button>
  </div>
  <div class="hint" id="modeHint">æ®µã”ã¨ã«ä¸€å®šã®é•·ã•ãšã¤å‡ç­‰ã«å°ã•ããªã‚Šã¾ã™ã€‚</div>

  <div id="ratioInput" style="display:none">
    <div class="field">
      <div class="field-top">
        <label>ç¸®å°æ¯”ç‡</label>
        <input type="number" id="ratio" value="0.85" min="0.5" max="0.99" step="0.01">
        <span class="unit"></span>
      </div>
      <input type="range" id="ratioR" min="50" max="99" step="1" value="85">
      <div class="hint">ä¸Šã®æ®µ = ä¸‹ã®æ®µ Ã— æ¯”ç‡ï¼ˆä¾‹ï¼š0.85 â†’ 85%ï¼‰</div>
    </div>
  </div>

  <div id="linearInput">
    <div class="field">
      <div class="field-top">
        <label>æœ€ä¸Šæ®µ Ã· æœ€ä¸‹æ®µ</label>
        <input type="number" id="linearRatio" value="0.4" min="0.1" max="0.9" step="0.01">
        <span class="unit"></span>
      </div>
      <input type="range" id="linearRatioR" min="10" max="90" step="1" value="40">
      <div class="hint">ä¾‹ï¼š0.4 â†’ æœ€ä¸Šæ®µã¯æœ€ä¸‹æ®µã® 40%</div>
    </div>
  </div>
</div>

<!-- çµæœ -->
<div class="card">
  <h2>è¨ˆç®—çµæœï¼ˆä¸‹ã‹ã‚‰é †ï¼‰</h2>
  <div class="error" id="errorMsg">å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
  <div class="seg-list" id="segList"></div>
  <div class="total-row">åˆè¨ˆ<span id="totalDisplay">â€”</span> mm</div>
</div>
```

  </div><!-- /pane-left -->

  <!-- å³ï¼šå›ºå®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->

  <div class="pane-right">
    <h2>Preview</h2>
    <canvas id="cv" width="270" height="900"></canvas>
    <button class="save-btn" id="saveBtn">ğŸ“¥ PNGä¿å­˜</button>
  </div>

</div><!-- /main -->

<script>
  let mode     = 'linear';
  let hasWaist = false;

  // â”€â”€ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨æ•°å€¤å…¥åŠ›ã®åŒæœŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // æ•´æ•°ç³»ï¼ˆ1:1å¯¾å¿œï¼‰
  const intPairs = [
    ['totalLen',    'totalLenR'],
    ['numSeg',      'numSegR'],
    ['widthBottom', 'widthBottomR'],
    ['widthTop',    'widthTopR'],
    ['waistSeg',    'waistSegR'],
    ['waistWidth',  'waistWidthR'],
  ];
  intPairs.forEach(([numId, rangeId]) => {
    const num   = document.getElementById(numId);
    const range = document.getElementById(rangeId);
    num.addEventListener('input', () => { range.value = num.value; calc(); });
    range.addEventListener('input', () => { num.value = range.value; calc(); });
  });

  // å°æ•°ç³»ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¯Ã—100ã§ä¿æŒï¼‰
  const floatPairs = [
    ['ratio',        'ratioR',        100],
    ['linearRatio',  'linearRatioR',  100],
  ];
  floatPairs.forEach(([numId, rangeId, scale]) => {
    const num   = document.getElementById(numId);
    const range = document.getElementById(rangeId);
    num.addEventListener('input', () => {
      range.value = Math.round(parseFloat(num.value) * scale);
      calc();
    });
    range.addEventListener('input', () => {
      num.value = (parseInt(range.value) / scale).toFixed(2);
      calc();
    });
  });

  // â”€â”€ ãã³ã‚Œãƒœã‚¿ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btnWaistNone').addEventListener('click', () => {
    hasWaist = false;
    document.getElementById('btnWaistNone').classList.add('active');
    document.getElementById('btnWaistOn').classList.remove('active');
    document.getElementById('waistInputs').style.display = 'none';
    calc();
  });
  document.getElementById('btnWaistOn').addEventListener('click', () => {
    hasWaist = true;
    document.getElementById('btnWaistOn').classList.add('active');
    document.getElementById('btnWaistNone').classList.remove('active');
    document.getElementById('waistInputs').style.display = '';
    calc();
  });

  // â”€â”€ å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒœã‚¿ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btnRatio').addEventListener('click', () => {
    mode = 'ratio';
    document.getElementById('btnRatio').classList.add('active');
    document.getElementById('btnLinear').classList.remove('active');
    document.getElementById('ratioInput').style.display = '';
    document.getElementById('linearInput').style.display = 'none';
    document.getElementById('modeHint').textContent = 'ä¸Šã®æ®µãŒä¸‹ã®æ®µã®ä¸€å®šæ¯”ç‡ã§å°ã•ããªã‚Šã¾ã™ã€‚';
    calc();
  });
  document.getElementById('btnLinear').addEventListener('click', () => {
    mode = 'linear';
    document.getElementById('btnLinear').classList.add('active');
    document.getElementById('btnRatio').classList.remove('active');
    document.getElementById('ratioInput').style.display = 'none';
    document.getElementById('linearInput').style.display = '';
    document.getElementById('modeHint').textContent = 'æ®µã”ã¨ã«ä¸€å®šã®é•·ã•ãšã¤å‡ç­‰ã«å°ã•ããªã‚Šã¾ã™ã€‚';
    calc();
  });

  // â”€â”€ è¨ˆç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function calc() {
    const total = parseFloat(document.getElementById('totalLen').value);
    const n     = Math.min(30, Math.max(2, parseInt(document.getElementById('numSeg').value) || 2));
    const errEl = document.getElementById('errorMsg');

    if (!total || total <= 0) { errEl.style.display = 'block'; return; }
    errEl.style.display = 'none';

    // ãã³ã‚Œã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æœ€å¤§å€¤ã‚’æ®µæ•°ã«åˆã‚ã›ã‚‹
    const waistSegR = document.getElementById('waistSegR');
    waistSegR.max = n - 1;
    const waistSegNum = document.getElementById('waistSeg');
    if (parseInt(waistSegNum.value) >= n) {
      waistSegNum.value = n - 1;
      waistSegR.value   = n - 1;
    }

    let heights = [];
    if (mode === 'ratio') {
      const r = parseFloat(document.getElementById('ratio').value) || 0.85;
      if (r >= 1 || r <= 0) return;
      const a = total * (1 - r) / (1 - Math.pow(r, n));
      for (let i = 0; i < n; i++) heights.push(a * Math.pow(r, i));
    } else {
      const lr = parseFloat(document.getElementById('linearRatio').value) || 0.4;
      const a  = total / (n * (1 - (1 - lr) / 2));
      const d  = a * (1 - lr) / (n - 1);
      for (let i = 0; i < n; i++) heights.push(a - d * i);
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«
    const list = document.getElementById('segList');
    list.innerHTML = '';
    const maxH = heights[0];
    let sum = 0;
    heights.forEach((h, i) => {
      sum += h;
      const div = document.createElement('div');
      div.className = 'seg-item';
      div.innerHTML = `
        <div class="seg-label">ç¬¬${i+1}æ®µç›®</div>
        <div class="seg-value">${h.toFixed(2)}</div>
        <div class="seg-unit">mm</div>
        <div class="seg-bar-wrap"><div class="seg-bar" style="width:${(h/maxH*100).toFixed(0)}%"></div></div>
      `;
      list.appendChild(div);
    });
    document.getElementById('totalDisplay').textContent = sum.toFixed(2);

    drawPreview(heights, n);
  }

  // â”€â”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function drawPreview(heights, n) {
    const cv  = document.getElementById('cv');
    const ctx = cv.getContext('2d');
    const pw  = cv.width, ph = cv.height;
    ctx.clearRect(0, 0, pw, ph);

    const pad    = 20;
    const total  = heights.reduce((a, b) => a + b, 0);
    const scaleY = (ph - pad * 2) / total;

    const wBottom  = parseFloat(document.getElementById('widthBottom').value) || 100;
    const wTop     = parseFloat(document.getElementById('widthTop').value)    || 20;
    const waistWmm = hasWaist ? (parseFloat(document.getElementById('waistWidth').value) || 15) : 0;
    const waistAt  = hasWaist
      ? Math.min(n - 1, Math.max(1, parseInt(document.getElementById('waistSeg').value) || 3))
      : 0;

    // å„å¢ƒç•Œã®Yåº§æ¨™ï¼ˆcanvasåº§æ¨™ï¼‰ã‚’äº‹å‰è¨ˆç®—
    const boundaryY = [ph - pad];
    for (let i = 0; i < n; i++) {
      boundaryY.push(boundaryY[i] - heights[i] * scaleY);
    }
    const totalPx = ph - pad * 2;

    // Yåº§æ¨™(canvas)ã‹ã‚‰å¹…(mm)ã‚’è¿”ã™ï¼ˆt=0:æœ€ä¸‹ç«¯ t=1:æœ€ä¸Šç«¯ï¼‰
    function widthAtY(y) {
      const t = (ph - pad - y) / totalPx;
      if (!hasWaist) {
        return wBottom + (wTop - wBottom) * t;
      }
      const tWaist = (ph - pad - boundaryY[waistAt]) / totalPx;
      if (t <= tWaist) {
        return wBottom + (waistWmm - wBottom) * (t / tWaist);
      } else {
        return waistWmm + (wTop - waistWmm) * ((t - tWaist) / (1 - tWaist));
      }
    }

    const wMax   = Math.max(wBottom, wTop, hasWaist ? waistWmm : 0);
    const wScale = (pw - pad * 2) / wMax;
    const cx = pw / 2;
    let y = ph - pad;

    heights.forEach((h, i) => {
      const segH = h * scaleY;
      const bw   = widthAtY(boundaryY[i])     * wScale;
      const tw   = widthAtY(boundaryY[i + 1]) * wScale;

      ctx.beginPath();
      ctx.moveTo(cx - bw/2, y);
      ctx.lineTo(cx + bw/2, y);
      ctx.lineTo(cx + tw/2, y - segH);
      ctx.lineTo(cx - tw/2, y - segH);
      ctx.closePath();
      ctx.strokeStyle = '#1a6b4a';
      ctx.lineWidth = 6;
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(cx - bw/2, y);
      ctx.lineTo(cx + tw/2, y - segH);
      ctx.moveTo(cx + bw/2, y);
      ctx.lineTo(cx - tw/2, y - segH);
      ctx.strokeStyle = '#aacfbe';
      ctx.lineWidth = 3;
      ctx.stroke();

      y -= segH;
    });
  }

  // â”€â”€ ä¿å­˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('saveBtn').addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = 'tower-preview.png';
    link.href = document.getElementById('cv').toDataURL('image/png');
    link.click();
  });

  calc();
</script>

</body>
</html>
